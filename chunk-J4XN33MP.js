import{a}from"./chunk-BXZ6GHR6.js";import"./chunk-X5YLR3NI.js";import{c as S,e as b,l as y}from"./chunk-IJ5FWROB.js";import{Da as g,Ia as p,Ma as h,Ra as f,ab as w,bb as c,cb as s,fb as v,gb as k,kb as m,lb as x}from"./chunk-F6HRXSUH.js";import{i as l}from"./chunk-ODN5LVDJ.js";function _(i,t){if(i&1&&(c(0,"p",4),m(1),s()),i&2){let e=k();g(),x(e.message)}}var C=class i{constructor(t){this.router=t}message="";redirectTo="https://kimmassesson.dk/#/login";ngOnInit(){return l(this,null,function*(){if(yield this.tryGetSessionFromUrlWithRetry(4,300)){localStorage.setItem("admin","true"),this.router.navigate(["/edit"]);return}try{let{data:{session:e}}=yield a.auth.getSession();if(e){localStorage.setItem("admin","true"),this.router.navigate(["/edit"]);return}}catch(e){console.warn("getSession fejl (ikke kritisk):",e)}a.auth.onAuthStateChange((e,n)=>{n&&(localStorage.setItem("admin","true"),this.router.navigate(["/edit"]))})})}tryGetSessionFromUrlWithRetry(t=3,e=300){return l(this,null,function*(){for(let n=0;n<t;n++)try{let r=new URLSearchParams(window.location.search).get("code");if(!r)return null;let{data:I,error:u}=yield a.auth.exchangeCodeForSession(r);if(u){let d=(u?.message||"").toLowerCase();if(d.includes("navigator lock")||d.includes("lockmanager")||d.includes("lock")){yield this.wait(e);continue}else return console.warn("getSessionFromUrl error:",u),null}return I?.session??null}catch(o){let r=String(o?.message||o).toLowerCase();if(r.includes("navigator lock")||r.includes("lockmanager")){yield this.wait(e);continue}return console.error("getSessionFromUrl kastede:",o),null}return console.warn("getSessionFromUrl: retries udl\xF8bet"),null})}wait(t){return new Promise(e=>setTimeout(e,t))}startOAuth(){return l(this,null,function*(){try{if(location.search.includes("code")||location.hash.includes("access_token")){this.message="Venter p\xE5 callback \u2014 genindl\xE6s hvis det ikke forts\xE6tter.";return}yield a.auth.signInWithOAuth({provider:"github",options:{redirectTo:this.redirectTo}})}catch(t){console.error("startOAuth fejl:",t),this.message="Fejl ved start af login. Pr\xF8v inkognito eller en anden browser."}})}static \u0275fac=function(e){return new(e||i)(p(y))};static \u0275cmp=h({type:i,selectors:[["app-login"]],decls:6,vars:1,consts:[[1,"max-w-md","mx-auto","mt-10","p-6","bg-white","rounded-lg","shadow-md"],[1,"text-xl","font-semibold","mb-4"],[1,"bg-blue-500","text-white","px-4","py-2","rounded-md","w-full",3,"click"],["class","mt-3 text-sm text-red-600",4,"ngIf"],[1,"mt-3","text-sm","text-red-600"]],template:function(e,n){e&1&&(c(0,"div",0)(1,"h2",1),m(2,"Login"),s(),c(3,"button",2),v("click",function(){return n.startOAuth()}),m(4," Login med GitHub "),s(),f(5,_,2,1,"p",3),s()),e&2&&(g(5),w("ngIf",n.message))},dependencies:[b,S],encapsulation:2})};export{C as LoginComponent};
